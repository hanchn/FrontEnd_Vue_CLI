import fs from 'fs'
import path from 'path'
import chokidar from 'chokidar'
import { fileURLToPath } from 'url'
import { dirname } from 'path'

const __filename = fileURLToPath(import.meta.url)
const __dirname = dirname(__filename)

class RouteGenerator {
  constructor() {
    this.pagesDir = path.resolve(__dirname, '../src/Pages')
    this.routerFile = path.resolve(__dirname, '../src/Router/index.js')
    this.routes = []
  }

  // æ‰«æPagesç›®å½•ç”Ÿæˆè·¯ç”±
  scanPages() {
    this.routes = []
    
    if (!fs.existsSync(this.pagesDir)) {
      console.log('Pagesç›®å½•ä¸å­˜åœ¨')
      return
    }

    const pageDirectories = fs.readdirSync(this.pagesDir, { withFileTypes: true })
      .filter(dirent => dirent.isDirectory())
      .map(dirent => dirent.name)

    pageDirectories.forEach(pageName => {
      const pagePath = path.join(this.pagesDir, pageName)
      const indexFile = path.join(pagePath, 'index.vue')
      
      if (fs.existsSync(indexFile)) {
        const route = this.generateRoute(pageName)
        this.routes.push(route)
        console.log(`âœ… å‘ç°é¡µé¢: ${pageName}`)
      }
    })

    console.log(`ğŸ“„ å…±å‘ç° ${this.routes.length} ä¸ªé¡µé¢`)
  }

  // ç”Ÿæˆå•ä¸ªè·¯ç”±é…ç½®
  generateRoute(pageName) {
    const routePath = pageName === 'Home' ? '/' : `/${pageName.toLowerCase()}`
    const componentPath = `../Pages/${pageName}/index.vue`
    
    return {
      path: routePath,
      name: pageName,
      component: componentPath,
      meta: {
        title: this.getPageTitle(pageName)
      }
    }
  }

  // è·å–é¡µé¢æ ‡é¢˜
  getPageTitle(pageName) {
    const titleMap = {
      'Home': 'é¦–é¡µ',
      'About': 'å…³äºæˆ‘ä»¬',
      'Contact': 'è”ç³»æˆ‘ä»¬'
    }
    return titleMap[pageName] || pageName
  }

  // ç”Ÿæˆè·¯ç”±æ–‡ä»¶å†…å®¹
  generateRouterContent() {
    const imports = this.routes.map(route => 
      `const ${route.name} = () => import('${route.component}')`
    ).join('\n')

    const routeConfigs = this.routes.map(route => `  {
    path: '${route.path}',
    name: '${route.name}',
    component: ${route.name},
    meta: {
      title: '${route.meta.title}'
    }
  }`).join(',\n')

    return `// æ­¤æ–‡ä»¶ç”±è„šæœ¬è‡ªåŠ¨ç”Ÿæˆï¼Œè¯·å‹¿æ‰‹åŠ¨ä¿®æ”¹
// Auto-generated by scripts/generateRoutes.js

import { createRouter, createWebHistory } from 'vue-router'

// åŠ¨æ€å¯¼å…¥é¡µé¢ç»„ä»¶
${imports}

const routes = [
${routeConfigs}
]

const router = createRouter({
  history: createWebHistory(),
  routes
})

// è·¯ç”±å®ˆå«
router.beforeEach((to, from, next) => {
  // è®¾ç½®é¡µé¢æ ‡é¢˜
  if (to.meta.title) {
    document.title = to.meta.title
  }
  next()
})

export default router
`
  }

  // å†™å…¥è·¯ç”±æ–‡ä»¶
  writeRouterFile() {
    const content = this.generateRouterContent()
    
    // ç¡®ä¿Routerç›®å½•å­˜åœ¨
    const routerDir = path.dirname(this.routerFile)
    if (!fs.existsSync(routerDir)) {
      fs.mkdirSync(routerDir, { recursive: true })
    }
    
    fs.writeFileSync(this.routerFile, content, 'utf8')
    console.log(`ğŸš€ è·¯ç”±æ–‡ä»¶å·²ç”Ÿæˆ: ${this.routerFile}`)
  }

  // ç”Ÿæˆè·¯ç”±
  generate() {
    console.log('ğŸ” å¼€å§‹æ‰«æé¡µé¢...')
    this.scanPages()
    this.writeRouterFile()
    console.log('âœ¨ è·¯ç”±ç”Ÿæˆå®Œæˆï¼')
  }

  // ç›‘å¬æ–‡ä»¶å˜åŒ–
  watch() {
    console.log('ğŸ‘€ å¼€å§‹ç›‘å¬æ–‡ä»¶å˜åŒ–...')
    console.log(`ç›‘å¬ç›®å½•: ${this.pagesDir}`)
    
    // åˆå§‹ç”Ÿæˆ
    this.generate()
    
    // ç›‘å¬Pagesç›®å½•å˜åŒ–
    const watcher = chokidar.watch(this.pagesDir, {
      ignored: /node_modules/,
      persistent: true,
      ignoreInitial: true
    })

    watcher
      .on('add', (filePath) => {
        if (path.basename(filePath) === 'index.vue') {
          console.log(`ğŸ“ æ£€æµ‹åˆ°æ–°é¡µé¢: ${filePath}`)
          this.generate()
        }
      })
      .on('unlink', (filePath) => {
        if (path.basename(filePath) === 'index.vue') {
          console.log(`ğŸ—‘ï¸  é¡µé¢å·²åˆ é™¤: ${filePath}`)
          this.generate()
        }
      })
      .on('addDir', (dirPath) => {
        console.log(`ğŸ“‚ æ–°å»ºç›®å½•: ${dirPath}`)
        // å»¶è¿Ÿæ£€æŸ¥ï¼Œç­‰å¾…å¯èƒ½çš„index.vueæ–‡ä»¶åˆ›å»º
        setTimeout(() => {
          this.generate()
        }, 1000)
      })
      .on('unlinkDir', (dirPath) => {
        console.log(`ğŸ“‚ åˆ é™¤ç›®å½•: ${dirPath}`)
        this.generate()
      })

    console.log('æŒ‰ Ctrl+C åœæ­¢ç›‘å¬')
    
    // ä¼˜é›…é€€å‡º
    process.on('SIGINT', () => {
      console.log('\nğŸ‘‹ åœæ­¢ç›‘å¬ï¼Œå†è§ï¼')
      watcher.close()
      process.exit(0)
    })
  }
}

// å‘½ä»¤è¡Œå‚æ•°å¤„ç†
const args = process.argv.slice(2)
const generator = new RouteGenerator()

if (args.includes('--watch') || args.includes('-w')) {
  // ç›‘å¬æ¨¡å¼
  generator.watch()
} else {
  // å•æ¬¡ç”Ÿæˆæ¨¡å¼
  generator.generate()
}

export default RouteGenerator